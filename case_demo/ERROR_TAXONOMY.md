# VAL 验证错误类型说明（Error Taxonomy）

本文档说明本系统对 VAL（Plan Validator）输出结果的错误分类规则及其语义定义，用于统一理解实验统计结果与后续自动化分析。

---

## 一、分类目标

本系统针对大模型（LLM）生成的 PDDL Plan，利用 VAL 进行自动化验证，并将验证结果划分为若干具有明确语义的错误类型，以支持：

- ✅ 规划正确率统计
- ✅ 失败模式分析
- ✅ 自动修复与闭环优化
- ✅ 实验可复现性与对比分析

---

## 二、错误类型总览

| 类型 | 标识字段 | 语义层级 | 是否有效 Plan |
|--------|------------|--------------|----------------|
| 正确 | `valid` | 正确 | ✅ |
| 结构错误 | `bad_plan` | 语法 / 结构层 | ❌ |
| 类型错误 | `type_error` | 类型语义层 | ❌ |
| 前置条件错误 | `unsatisfied_precondition` | 规划语义层 | ❌ |
| 未识别错误 | `unknown` | 系统 / 未分类 | ❌ |

---

## 三、各类型详细定义

---

### 🟢 valid — 正确规划

**定义：**

VAL 成功验证该 Plan，并明确输出 `Plan valid`，说明该 Plan 满足所有动作前置条件、状态约束以及目标条件，在逻辑上可正确执行。

**判定依据：**

- 日志中出现：
```

Plan valid

````
- 且解析结果中：
```json
"parsed": { "success": true }
````

**含义：**

该 Plan 可被视为语义正确的规划结果。

---

---

### 🔴 bad_plan — 结构 / 格式错误

**定义：**

VAL 无法正确解析或执行该 Plan，通常由于 Plan 文件结构错误、动作格式不合法、参数数量不匹配或语法缺失导致。

**典型日志特征：**

* ```
  Bad plan description!
  ```
* ```
  Failed plans:
  ```

**常见原因：**

* LLM 输出格式不符合 PDDL 或 Plan 文件规范
* 缺失括号、非法符号
* Action 参数数量错误
* 行格式错误或乱码

**语义层级：**

结构层 / 语法层错误。

---

---

### 🟠 type_error — 类型错误

**定义：**

Plan 中某个 Action 的参数类型与 Domain 中定义的类型约束不一致，导致类型检查失败。

**典型日志特征：**

* ```
  Type problem in action
  ```

**常见原因：**

* 对象类型选择错误
* 参数顺序错误
* 使用了未声明对象
* 类型约束理解错误

**语义层级：**

类型语义层错误。

---

---

### 🔵 unsatisfied_precondition — 前置条件未满足

**定义：**

某个 Action 在执行时，其前置条件在当前状态下未被满足，导致执行失败。

**典型日志特征：**

* ```
  unsatisfied precondition
  ```
* ```
  Plan failed because of unsatisfied precondition
  ```

**常见原因：**

* Action 执行顺序错误
* 缺失必要前置动作
* 状态更新逻辑错误
* LLM 推理路径不完整

**语义层级：**

规划逻辑层错误。

---

---

### ⚫ unknown — 未识别错误

**定义：**

当前解析规则未能匹配到任何已知错误模式的输出。

**可能原因：**

* VAL 输出格式变化
* 系统异常输出未被覆盖
* 日志截断或混合异常
* 新类型错误尚未加入规则库

**处理建议：**

* 对原始日志进行人工检查
* 扩展错误匹配规则
* 保留原始日志以支持后续调试

**语义层级：**

系统层 / 未分类错误。

---

## 四、分类层级总结

从低层到高层，错误类型对应不同抽象层级：

```
结构层错误 (bad_plan)
      ↓
类型层错误 (type_error)
      ↓
规划语义错误 (unsatisfied_precondition)
      ↓
正确规划 (valid)
```

`unknown` 表示暂未覆盖的异常情况。

---

## 五、应用场景

该错误分类体系可用于：

* 📊 统计不同失败模式比例
* 🔁 指导 Prompt 优化与模型迭代
* 🧪 分析模型规划能力瓶颈
* 🤖 构建自动修复与反馈机制

---

## 六、扩展说明

如发现新的错误模式，可在代码中的错误模式注册表中扩展：

```python
ERROR_PATTERNS = [
    ("bad_plan", r"..."),
    ("type_error", r"..."),
    ...
]
```

同时应同步更新本说明文档，以保证实验语义一致性。

---